async function showMonitoringPage(role) {
    const contentArea = document.getElementById('dashboard-content');
    let html = '<h2>صفحة الرصد والتحليل</h2>';
    if (role === 'monitor') {
        html += `
            <div class="form-container">
                <h3>إضافة رصد جديد</h3>
                <input type="text" id="entity" placeholder="الكيان">
                <select id="monitoring-type">
                    <option value="social">شبكات اجتماعية</option>
                    <option value="website">مواقع إلكترونية</option>
                    <option value="channel">قنوات تلفزيونية</option>
                </select>
                <input type="text" id="link" placeholder="الرابط">
                <textarea id="content" placeholder="المحتوى"></textarea>
                <input type="date" id="monitoring-date">
                <button id="save-monitoring-btn">حفظ الرصد</button>
            </div>
        `;
    }
    html += '<div id="data-display-area"><h3>البيانات المرصودة</h3><div id="items-container"></div></div>';
    contentArea.innerHTML = html;
    if (role === 'monitor') {
        document.getElementById('save-monitoring-btn').addEventListener('click', saveMonitoringData);
    }
    fetchAndDisplayData(role);
}

async function saveMonitoringData() {
    const newData = {
        entity: document.getElementById('entity').value,
        monitoring_type: document.getElementById('monitoring-type').value,
        link: document.getElementById('link').value,
        content: document.getElementById('content').value,
        monitoring_date: document.getElementById('monitoring-date').value
    };
    const { error } = await supabase.from('monitoring_data').insert([newData]);
    if (error) alert('فشل حفظ البيانات.');
    else {
        alert('تم حفظ البيانات بنجاح!');
        fetchAndDisplayData('monitor');
    }
}

async function fetchAndDisplayData(role) {
    const itemsContainer = document.getElementById('items-container');
    itemsContainer.innerHTML = '<p>جاري تحميل البيانات...</p>';
    const { data: monitoringData, error: monitoringError } = await supabase.from('monitoring_data').select('*').order('created_at', { ascending: false });
    if (monitoringError) {
        itemsContainer.innerHTML = '<p>فشل تحميل البيانات.</p>';
        return;
    }
    if (monitoringData.length === 0) {
        itemsContainer.innerHTML = '<p>لا توجد بيانات لعرضها.</p>';
        return;
    }
    const { data: analysisData, error: analysisError } = await supabase.from('analysis_data').select('*');
    let html = '';
    for (const item of monitoringData) {
        const relatedAnalysis = analysisData ? analysisData.find(a => a.monitoring_data_id === item.id) : null;
        html += `
            <div class="data-item">
                <p><strong>الكيان:</strong> ${item.entity}</p>
                <p><strong>النوع:</strong> ${item.monitoring_type}</p>
                <p><strong>التاريخ:</strong> ${item.monitoring_date}</p>
                <p><strong>المحتوى:</strong> ${item.content.substring(0, 100)}...</p>
                <div class="analysis-section" id="analysis-for-${item.id}">`;
        if (role === 'analyst') {
            if (relatedAnalysis) {
                html += `<h4>التحليل والتوصيات (محفوظة)</h4><p><strong>التحليل:</strong> ${relatedAnalysis.analysis}</p><p><strong>التوصيات:</strong> ${relatedAnalysis.recommendations}</p>`;
            } else {
                html += `<h4>إضافة تحليل وتوصيات</h4><textarea id="analysis-text-${item.id}" placeholder="اكتب التحليل هنا"></textarea><textarea id="recommendations-text-${item.id}" placeholder="اكتب التوصيات هنا"></textarea><button onclick="saveAnalysisData(${item.id})">حفظ التحليل</button>`;
            }
        } else {
            if (relatedAnalysis) {
                html += `<h4>التحليل والتوصيات</h4><p><strong>التحليل:</strong> ${relatedAnalysis.analysis}</p><p><strong>التوصيات:</strong> ${relatedAnalysis.recommendations}</p>`;
            } else {
                html += '<p><em>لم يتم إضافة تحليل بعد.</em></p>';
            }
        }
        html += `</div></div>`;
    }
    itemsContainer.innerHTML = html;
}

async function saveAnalysisData(monitoringId) {
    const newData = {
        monitoring_data_id: monitoringId,
        analysis: document.getElementById(`analysis-text-${monitoringId}`).value,
        recommendations: document.getElementById(`recommendations-text-${monitoringId}`).value
    };
    const { error } = await supabase.from('analysis_data').insert([newData]);
    if (error) alert('فشل حفظ التحليل.');
    else {
        alert('تم حفظ التحليل بنجاح!');
        fetchAndDisplayData('analyst');
    }
}
